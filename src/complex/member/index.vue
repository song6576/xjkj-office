<template>
  <div v-if="visible" class="overlay" @click.self="handleOverlayClick">
    <div class="w-full h-full" @click.self="handleOverlayClick">
      <div
        class="my-modal rounded-md relative px-50 py-10"
        :style="`width: ${width}px`"
        @click.stop
      >
        <div class="content flex flex-col flex-ai w-100">
          <div class="title fs-24 flex flex-ai">
            <img
              src="https://www.duya888.com/wp-content/uploads/2024/06/20240617015052106-vip1.webp"
              width="70"
              height="70"
              alt="ä¼šå‘˜"
            /><span class="ml-12 mt-5">ç’‡æœºç§‘æŠ€-æ°¸ä¹…ä¼šå‘˜</span>
          </div>
          <div class="vip_text">å¼€é€šVIPä¼šå‘˜ï¼Œäº«å—ä¼šå‘˜ä¸“å±æŠ˜æ‰£ä»¥åŠå¤šé¡¹ç‰¹æƒ</div>
          <div class="flex flex-ai flex-jc mt-20 vip-card w-100">
            <img
              src="https://www.duya888.com/wp-content/uploads/2024/06/20240617015052106-vip1.webp"
              width="50"
              height="50"
              alt="ä¼šå‘˜"
            />
            <div class="vip-baicon"></div>
            <div class="ml-12 mt-5 fs-20">ç¤¾ç¾¤æ°¸ä¹…ä¼šå‘˜</div>
          </div>
          <div class="flex mt-20 w-100">
            <div class="flex-1">
              <div class="line flex flex-ai w-100 fs-17">
                <div style="color: #000;">ã€Œæ ¸å¿ƒè¯¾ç¨‹æƒç›Šã€</div>
              </div>
              <div class="dsy flex flex-ai flex-jc w-100 text-center mt-20 fs-14">
                âš¡ï¸ åŒ—æ–—ä¸ƒç»´åˆ›ä½œä½“ç³»ç»ˆèº«ç•…å­¦
                <br />å¤©æ¢ï¼š15ç§’çˆ†æ¬¾å…¬å¼è®­ç»ƒè¥+é»„é‡‘å¼€å¤´æ³•åˆ™<br />å¤©ç’‡ï¼šæƒ…ç»ªé’©å­+ä¿¡æ¯å¯†åº¦åŒèºæ—‹æ¨¡å‹<br />
                å¤©ç‘ï¼šæµé‡æ²™ç›˜æ¨æ¼”ç³»ç»Ÿå®æˆ˜æ•™å­¦ <br />å¤©æƒï¼šæ°”åœºå¼ºåº¦åˆ†çº§è®­ç»ƒä½“ç³»
                <br />å¤©è¡¡ï¼šè·¨å¹³å°ä¸€ç¨¿å¤šå‰ªå®æˆ˜ç³»ç»Ÿ
                <br />å¼€é˜³ï¼šä¸‰å¹•å‰§äººè®¾å¡‘é€ æ³•å…¨æ¡ˆ <br />ç‘¶å…‰ï¼šç”µå½±çº§è§†å¬è¯­è¨€å¼€å‘è¯¾ç¨‹ <br />
                ğŸ›  ä»·å€¼ä¸‡å…ƒåˆ›ä½œå·¥å…·åŒ…<br />
                âˆš å…¨è¡Œä¸šè‡ªçƒ­å®æˆ˜SOPæ¨¡æ¿åº“<br />
                âˆš æŠ–éŸ³AIäº‘æ§çŸ©é˜µå…‹éš†ç³»ç»Ÿï¼ˆ1å¹´ï¼‰<br />
                âˆš å…¨å¹³å°ADæŠ•æµå®æ“æ•™å­¦ç³»ç»Ÿ<br />
                ç’‡æœºè·³è½¬å¤–é“¾å¹³å°è‡³å°Šä¼šå‘˜ï¼ˆ30å¤©ï¼‰<br />
                â˜… ä¸“å±VIPå¾®ä¿¡ç¾¤ï¼ˆå®æ—¶ç­”ç–‘ï¼‰<br />
                â˜… çˆ†æ¬¾æ¡ˆä¾‹æ‹†è§£è§†é¢‘ç‰¹æƒ<br />
                â˜… é£ä¹¦ä¸‡äººå¤§å‚çº§èµ„æºæ± 
              </div>
            </div>
            <div class="flex flex-col ml-20 flex-1">
              <div class="flex flex-ai flex-wrap">
                <div
                  class="flex flex-col member_price_box flex-ai flex-jc ml-10 cp"
                  v-for="(item, index) in levelList"
                  :key="index"
                  :class="{ active: memberIndex === index }"
                  @click="handleMemberClick(item, index)"
                >
                  <div class="level fs-18">{{ item.levelName }}</div>
                  <div class="flex flex-ai mt-25" style="color: red">
                    <div class="fs-14 mt-5">ä¼šå‘˜ä»·</div>
                    <div class="fs-20 pl-3">{{ item.money }}</div>
                  </div>
                  <div class="flex flex-ai fs-12 member_price_box_zk mt-2">
                    <div>ä¼šå‘˜ä»·</div>
                    <div>{{ item.originalPrice }}</div>
                  </div>
                  <div class="fs-14 mt-2" style="color: #2997f7">æ°¸ä¹…</div>
                </div>
              </div>
              <div class="fs-12 muted-box" style="line-height: 22px; letter-spacing: 1px">
                <div>è´­ä¹°åä¸æ”¯æŒé€€æ¬¾</div>
                <div>VIPæƒç›Šä»…é€‚ç”¨äºæœ¬ç«™</div>
                <div>æ¬¢è¿ä¸ç«™é•¿è”ç³»</div>
                <div>è´­ä¹°åä¸æ”¯æŒé€€æ¬¾</div>
              </div>
              <div class="mt-20">
                <div class="fs-14">æ”¯ä»˜æ–¹å¼</div>
                <div class="flex flex-col pay-box mt-10 flex-ai flex-jc">
                  <img src="@/assets/wx.png" width="30" height="30" alt="å¾®ä¿¡" />
                  <div class="fs-12 pt-5">å¾®ä¿¡</div>
                </div>
              </div>
              <div class="btn mt-20 cp" @click="handlePay" v-if="!btnShow">ç«‹å³æ”¯ä»˜</div>
              <div class="btn mt-20 cp" style="background: #999 !important" v-else>
                å·²ç¼´çº³è¿‡
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="qrcode-box" v-if="showQrcode" @click="hideQrcode">
    <div class="qrcode-container flex flex-col flex-ai">
      <div class="fs-17">å¾®ä¿¡æ‰«ç æ”¯ä»˜</div>
      <canvas ref="qrcodeCanvas"></canvas>
    </div>
  </div>
  <div class="payStatus" v-if="showPayStatus" @click="hidePayStatus">
    <div class="payStatus-container">
      <div class="flex flex-col flex-ai">
        <img
          src="https://www.duya888.com/wp-content/uploads/2024/06/20240617015052106-vip1.webp"
          width="100"
          height="100"
          alt="ä¼šå‘˜"
        />
        <div class="fs-20">ç’‡æœºç§‘æŠ€</div>
      </div>
      <div class="flex flex-ai flex-jc mt-20">
        <div class="payText flex flex-ai flex-jc">{{ payText }}</div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, onMounted, onBeforeUnmount, ref, nextTick } from "vue";
import { useUserStore } from "@/store";
import { getMemberLevel, createOrder, getOrderDetail } from "@/api/member";
import { ElMessage } from "element-plus";
import QRCode from "qrcode";
import { getLoginDetail } from "@/api/login";

const qrcodeCanvas = ref(null);

// å®šä¹‰ props
const props = defineProps({
  width: {
    type: Number,
    default: 870,
  },
});

onMounted(() => {
  getMemberLevels();
});
const showQrcode = ref(false);
const showPayStatus = ref(false);
const payText = ref("");
const levelId = ref(0);
const levelList = ref([]);
const memberIndex = ref(0);
const payQr = ref(true);
const getMemberLevels = async () => {
  const { data } = await getMemberLevel();
  levelList.value = data;
  levelId.value = data[0].id;
  btnShow.value = data[0].isShow;
};
const hideQrcode = () => {
  showQrcode.value = false;
};
const btnShow = ref(false);
const handleMemberClick = (item, index) => {
  memberIndex.value = index;
  levelId.value = item.id;
  btnShow.value = levelList.value[index].isShow;
};

const hidePayStatus = () => {
  showPayStatus.value = false;
  handleOverlayClick();
  showQrcode.value = false;
  clearInterval(timer);
};

const getOrderDetails = async (portalOrderId) => {
  const userInfo = JSON.parse(localStorage.getItem("userInfo"));
  const res = await getOrderDetail({
    portalOrderId,
  });
  if (res.data.orderState === 1) {
    clearInterval(timer.value);
    showPayStatus.value = true;
    payText.value = "æ”¯ä»˜æˆåŠŸ";
    const userData = await getLoginDetail({
      userId: userInfo.id,
    })
    // æŠŠuserData.dataå¯¹è±¡è½¬æˆå­—ç¬¦ä¸²çš„å½¢å¼
    const userDataString = JSON.stringify(userData.data);
    // å°†å­—ç¬¦ä¸²å­˜å‚¨åˆ°localStorageä¸­
    localStorage.setItem("userInfo", userDataString);
    showQrcode.value = false;
    setTimeout(() => {
      handleOverlayClick();
      window.location.reload();
    },4000)
  } else if (res.data.orderState === 2) {
    clearInterval(timer.value);
    showPayStatus.value = true;
    payText.value = "æ”¯ä»˜å¤±è´¥";
    const userData = await getLoginDetail({
      userId: userInfo.id,
    })
    localStorage.setItem("userInfo", userData);
    showQrcode.value = false;
    setTimeout(() => {
      handleOverlayClick();
      window.location.reload();
    },4000)
  }
};
const userStore = useUserStore();
const timer = ref(null);
const handlePay = async () => {
  const isLogin = userStore.getIsLogin();
  if (!isLogin) {
    ElMessage.warning("ä½ è¿˜æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ï¼");
    userStore.hideMemberModal();
    userStore.showLoginModal();
  } else {
    const userInfo = userStore.getUserInfo();
    if (payQr.value) {
      payQr.value = false;
      const res = await createOrder({
        levelId: levelId.value,
        userId: userInfo.id,
      });
      payQr.value = true;
      showQrcode.value = true;
      const url = res.data.codeUrl;
      await nextTick(() => {
        const canvas = qrcodeCanvas.value;
        QRCode.toCanvas(
          canvas,
          url,
          {
            width: 200,
            height: 200,
          },
          (error) => {
            if (error) {
              clearInterval(timer.value);
            } else {
              // if(showPayStatus.value){
              timer.value = setInterval(() => {
                getOrderDetails(res.data.portalOrderId);
              }, 2000);
              // }
              console.log("canvas", canvas);
              console.log("äºŒç»´ç ç”ŸæˆæˆåŠŸ");
            }
          }
        );
      });
    }
  }
};

// ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
onBeforeUnmount(() => {
  clearInterval(timer.value);
});

// è®¡ç®—å±æ€§ visible
const visible = computed(() => userStore.isMemberModalVisible);

// å®šä¹‰æ–¹æ³•
const handleOverlayClick = () => {
  userStore.hideMemberModal();
};
</script>

<style scoped>
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 999;
}

.my-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
  max-width: 90%;
  z-index: 1035;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.line {
  color: #6d6d6d;
}
.line::after,
.line::before {
  content: "";
  background: rgba(50, 50, 50, 0.18);
  width: 50px;
  height: 2px;
  margin: 0 10px;
  flex: 1;
}
.vip_text {
  font-size: 14px;
  color: red;
  margin-top: 10px;
}
.vip-card {
  overflow: hidden;
  position: relative;
  border-radius: 6px;
  padding: 15px;
  height: 80px;
  background: #d2b484;
  background: linear-gradient(25deg, #e6aa4f 10%, #f1d7ad 70%, #f5b97b 100%);
  color: #866127;
  box-shadow: 0 0 10px rgba(98, 98, 98, 0.6);
  transform: translateY(-1px);
}
.vip-baicon {
  position: absolute;
  top: -4px;
  left: -3%;
  opacity: 0.2;
  z-index: 0;
  width: 600px;
  height: 600px;
  background: url(https://www.duya888.com/wp-content/uploads/2024/06/20240617015052106-vip1.webp)
    no-repeat;
}
.dsy {
  color: #6d6d6d;
  line-height: 28px;
}
.member_price_box_zk {
  position: relative;
  color: #6d6d6d;
}
.member_price_box_zk::before {
  content: "";
  position: absolute;
  width: 100%;
  height: 1px;
  background: red;
  top: 0.6em;
  left: 0;
  transform: rotate(5deg);
}
.member_price_box {
  position: relative;
  width: 90px;
  padding: 5px 15px;
  border-radius: 8px;
  border: 1px solid #6d6d6d;
  background-color: #fff;
}
.active {
  border: 2px solid red;
}
.level {
  position: absolute;
  top: -2px;
  left: 0px;
  color: #ffffff;
  background-color: red;
  border-radius: 8px 0px 8px 0px;
  padding: 2px 5px;
  font-size: 12px;

}
.muted-box {
  background: rgba(0, 0, 0, 0.03);
  border-radius: 8px;
  color: #999;
  padding: 10px;
  margin-top: 20px;
}
.btn {
  background: linear-gradient(135deg, #fd7a64 10%, #fb2d2d 100%);
  color: #fff;
  border-radius: 18px;
  padding: 10px;
  text-align: center;
}
.pay-box {
  width: 50px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #1e73be;
}
.qrcode-box,
.payStatus {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /* left: 50%; */
  z-index: 9999999;
  /* width: 100%;
  height: 100%; */
  background-color: rgba(0, 0, 0, 0.5);
}
.qrcode-container {
  background-color: #fff;
  position: absolute;
  top: 50%;
  left: 50%;
  padding: 10px;
  transform: translate(-50%, -50%);
}
.payStatus-container {
  position: absolute;
  top: 50%;
  left: 50%;
  padding: 10px;
  transform: translate(-50%, -50%);
  width: 220px;
  height: 200px;
  border-radius: 12px;
  background-color: #fff;
}
.payText {
  width: 100px;
  border-radius: 15px;
  color: #866127;
  padding: 2px 8px;
  background: linear-gradient(25deg, #e6aa4f 10%, #f1d7ad 70%, #f5b97b 100%);
}
</style>
